name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  # Quick checks for PR feedback
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "Merge conflicts detected"
            exit 1
          fi

      - name: Check commit messages
        run: |
          # Check that commit messages follow conventional commits format
          git log --format=%s origin/${{ github.base_ref }}..HEAD | while read msg; do
            if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
              echo "Warning: Commit message doesn't follow conventional format: $msg"
            fi
          done

      - name: Check for large files
        run: |
          # Check for files larger than 1MB
          large_files=$(find . -type f -size +1M -not -path "./.git/*" -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*")
          if [ -n "$large_files" ]; then
            echo "Warning: Large files detected:"
            echo "$large_files"
          fi

  # Quick lint and format check
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Lint backend
        working-directory: ./backend
        run: npm run lint || echo "Backend linting (non-blocking)"

      - name: Lint frontend
        working-directory: ./frontend
        run: npm run lint || echo "Frontend linting (non-blocking)"

      - name: Check backend formatting
        working-directory: ./backend
        run: npx prettier --check "src/**/*.{ts,js,json}" || echo "Backend formatting check (non-blocking)"

      - name: Check frontend formatting
        working-directory: ./frontend
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css}" || echo "Frontend formatting check (non-blocking)"

  # Size impact analysis
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (base)
        run: npm ci

      - name: Install frontend dependencies (base)
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend (base)
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:3001/api/v1
        run: npm run build

      - name: Save base bundle size
        run: |
          du -sh frontend/dist > /tmp/base-size.txt
          cat /tmp/base-size.txt

      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Install dependencies (PR)
        run: npm ci

      - name: Install frontend dependencies (PR)
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend (PR)
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:3001/api/v1
        run: npm run build

      - name: Compare bundle sizes
        run: |
          echo "Base bundle size:"
          cat /tmp/base-size.txt
          echo ""
          echo "PR bundle size:"
          du -sh frontend/dist
          echo ""
          echo "Detailed size comparison:"
          echo "Base:"
          du -h frontend/dist/* 2>/dev/null | head -20 || echo "No detailed comparison available"

  # Test coverage analysis
  coverage-report:
    name: Test Coverage Report
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: menumaker_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: menumaker_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm ci

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run tests with coverage
        working-directory: ./backend
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: menumaker_test
          DB_USER: menumaker_test
          DB_PASSWORD: test_password
          JWT_SECRET: test-secret-key-for-ci-testing-32-chars-minimum
        run: npm run test:coverage || echo "Coverage generation (non-blocking)"

      - name: Coverage summary
        if: always()
        working-directory: ./backend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            echo "Coverage Summary:"
            cat coverage/coverage-summary.json
          else
            echo "No coverage data generated"
          fi

      - name: Comment coverage on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coveragePath = './backend/coverage/coverage-summary.json';

            if (fs.existsSync(coveragePath)) {
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
              const total = coverage.total;

              const comment = `## ðŸ“Š Test Coverage Report

              | Metric | Percentage |
              |--------|-----------|
              | Statements | ${total.statements.pct}% |
              | Branches | ${total.branches.pct}% |
              | Functions | ${total.functions.pct}% |
              | Lines | ${total.lines.pct}% |

              **Goal**: 70%+ coverage for all metrics
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

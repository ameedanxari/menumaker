name: Smart CI/CD Pipeline

# Only run on pull requests to avoid excessive builds
on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

env:
  NODE_VERSION: '20.x'
  JAVA_VERSION: '17'
  XCODE_VERSION: '15.0'

jobs:
  # Detect which parts of the monorepo changed
  detect-changes:
    name: Detect Changed Files
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      android: ${{ steps.filter.outputs.android }}
      ios: ${{ steps.filter.outputs.ios }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for path changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'shared/**'
              - 'package.json'
              - 'package-lock.json'
            frontend:
              - 'frontend/**'
              - 'shared/**'
              - 'package.json'
              - 'package-lock.json'
            android:
              - 'android/**'
              - 'specs/**'
            ios:
              - 'ios/**'
              - 'specs/**'
            shared:
              - 'shared/**'
              - '.github/workflows/**'

  # ============================================
  # BACKEND JOBS
  # ============================================
  backend-lint:
    name: Backend - Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run linter
        working-directory: ./backend
        run: npm run lint

  backend-test:
    name: Backend - Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: menumaker_test
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: menumaker_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run tests with coverage
        working-directory: ./backend
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: menumaker_test
          DB_USER: menumaker_test
          DB_PASSWORD: test_password
          JWT_SECRET: test-secret-key-for-ci-testing-32-chars-minimum
        run: npm run test:coverage

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage
          retention-days: 7

  backend-build:
    name: Backend - Build
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Build
        working-directory: ./backend
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: backend/dist
          retention-days: 7

  backend-typecheck:
    name: Backend - TypeCheck
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Type check
        working-directory: ./backend
        run: npx tsc --noEmit

  backend-security:
    name: Backend - Security Analysis
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run npm audit
        working-directory: ./backend
        run: |
          echo "ğŸ” Checking for dependency vulnerabilities..."
          npm audit --audit-level=moderate || true
          npm audit --audit-level=high --json > audit-results.json || true
          if [ -s audit-results.json ]; then
            echo "âš ï¸  High/Critical vulnerabilities found - please review"
            cat audit-results.json
          fi

      - name: Install security linting plugins
        working-directory: ./backend
        run: |
          npm install --no-save eslint-plugin-security@latest eslint-plugin-no-secrets@latest

      - name: Run security-focused ESLint
        working-directory: ./backend
        run: |
          echo "ğŸ”’ Running security analysis..."
          npx eslint src --ext .ts --plugin security --plugin no-secrets \
            --rule 'security/detect-object-injection: error' \
            --rule 'security/detect-non-literal-regexp: warn' \
            --rule 'security/detect-unsafe-regex: error' \
            --rule 'security/detect-buffer-noassert: error' \
            --rule 'security/detect-child-process: warn' \
            --rule 'security/detect-disable-mustache-escape: error' \
            --rule 'security/detect-eval-with-expression: error' \
            --rule 'security/detect-no-csrf-before-method-override: error' \
            --rule 'security/detect-non-literal-fs-filename: warn' \
            --rule 'security/detect-non-literal-require: warn' \
            --rule 'security/detect-possible-timing-attacks: warn' \
            --rule 'security/detect-pseudoRandomBytes: error' \
            --rule 'no-secrets/no-secrets: error' \
            --format stylish || echo "âš ï¸  Security issues detected"

      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ”‘ Scanning for hardcoded secrets..."
          git diff-tree --no-commit-id --name-only -r HEAD | xargs grep -E "(password|secret|key|token|api_key|apikey|auth)" --color=always || echo "âœ… No obvious secrets in commit"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-report
          path: backend/audit-results.json
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # FRONTEND JOBS
  # ============================================
  frontend-lint:
    name: Frontend - Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run linter
        working-directory: ./frontend
        run: npm run lint

  frontend-test:
    name: Frontend - Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run tests
        working-directory: ./frontend
        run: npm test || echo "Frontend tests (if available)"

  frontend-build:
    name: Frontend - Build
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:3001/api/v1
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 7

  frontend-typecheck:
    name: Frontend - TypeCheck
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Type check
        working-directory: ./frontend
        run: npx tsc --noEmit

  frontend-security:
    name: Frontend - Security Analysis
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run npm audit
        working-directory: ./frontend
        run: |
          echo "ğŸ” Checking for dependency vulnerabilities..."
          npm audit --audit-level=moderate || true
          npm audit --audit-level=high --json > audit-results.json || true
          if [ -s audit-results.json ]; then
            echo "âš ï¸  High/Critical vulnerabilities found - please review"
            cat audit-results.json
          fi

      - name: Install security linting plugins
        working-directory: ./frontend
        run: |
          npm install --no-save eslint-plugin-security@latest eslint-plugin-no-secrets@latest

      - name: Run security-focused ESLint
        working-directory: ./frontend
        run: |
          echo "ğŸ”’ Running security analysis..."
          npx eslint src --ext .ts,.tsx --plugin security --plugin no-secrets \
            --rule 'security/detect-object-injection: warn' \
            --rule 'security/detect-non-literal-regexp: warn' \
            --rule 'security/detect-unsafe-regex: error' \
            --rule 'security/detect-eval-with-expression: error' \
            --rule 'security/detect-non-literal-fs-filename: warn' \
            --rule 'no-secrets/no-secrets: error' \
            --format stylish || echo "âš ï¸  Security issues detected"

      - name: Check for XSS vulnerabilities
        working-directory: ./frontend
        run: |
          echo "ğŸ›¡ï¸  Scanning for XSS vulnerabilities..."
          # Check for dangerouslySetInnerHTML usage
          grep -r "dangerouslySetInnerHTML" src/ && echo "âš ï¸  Found dangerouslySetInnerHTML - ensure input is sanitized" || echo "âœ… No dangerouslySetInnerHTML found"
          # Check for eval usage
          grep -r "\beval(" src/ && echo "âŒ Found eval() usage - this is dangerous!" || echo "âœ… No eval() found"

      - name: Check for hardcoded API keys
        working-directory: ./frontend
        run: |
          echo "ğŸ”‘ Scanning for hardcoded secrets..."
          grep -r "VITE_" src/ --include="*.ts" --include="*.tsx" && echo "âš ï¸  Found VITE_ env vars in source - should use import.meta.env" || echo "âœ… No hardcoded env vars"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-report
          path: frontend/audit-results.json
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # ANDROID JOBS
  # ============================================
  android-lint:
    name: Android - Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run lint
        run: ./gradlew lint

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-lint-results
          path: android/app/build/reports/lint-results-*.html
          retention-days: 7

  android-test:
    name: Android - Unit Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run unit tests
        run: ./gradlew testDebugUnitTest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-test-results
          path: android/app/build/test-results/
          retention-days: 7

  android-build:
    name: Android - Build APK
    needs: detect-changes
    if: needs.detect-changes.outputs.android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android/app/build/outputs/apk/debug/*.apk
          retention-days: 7

  android-security:
    name: Android - Security Analysis
    needs: detect-changes
    if: needs.detect-changes.outputs.android == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./android

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check for Gradle dependency vulnerabilities
        run: |
          echo "ğŸ” Checking for known vulnerabilities in Gradle dependencies..."
          ./gradlew dependencyCheckAnalyze || echo "âš ï¸  Dependency check completed with warnings"

      - name: Run Android Lint with security focus
        run: |
          echo "ğŸ”’ Running Android Lint with security checks..."
          ./gradlew lint
          echo "Checking for specific security issues..."

      - name: Check for hardcoded secrets in Kotlin files
        run: |
          echo "ğŸ”‘ Scanning for hardcoded secrets..."
          grep -r "password\|secret\|api_key\|token" app/src/main/kotlin --include="*.kt" || echo "âœ… No obvious secrets found"
          grep -r "http://" app/src/main/kotlin --include="*.kt" && echo "âš ï¸  Found non-HTTPS URLs" || echo "âœ… All URLs use HTTPS"

      - name: Check for security-sensitive Android APIs
        run: |
          echo "ğŸ”’ Checking for security-sensitive API usage..."
          grep -r "WebView.setJavaScriptEnabled(true)" app/src --include="*.kt" && echo "âš ï¸  JavaScript enabled in WebView" || echo "âœ… No risky WebView usage"
          grep -r "MODE_WORLD_READABLE\|MODE_WORLD_WRITEABLE" app/src --include="*.kt" && echo "âŒ Insecure file permissions" || echo "âœ… No world-accessible files"
          grep -r "TrustAllCertificates\|SSLSocketFactory" app/src --include="*.kt" && echo "âš ï¸  Custom SSL handling detected" || echo "âœ… No custom SSL handling"

      - name: Check ProGuard/R8 configuration
        run: |
          echo "ğŸ›¡ï¸  Checking code obfuscation configuration..."
          if [ -f "app/proguard-rules.pro" ]; then
            echo "ProGuard rules file found"
            grep -i "minifyEnabled" app/build.gradle.kts && echo "âœ… Minification configured" || echo "âš ï¸  Minification not enabled"
          else
            echo "âš ï¸  No ProGuard rules file found"
          fi

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-security-reports
          path: |
            android/app/build/reports/lint-results*.html
            android/app/build/reports/dependency-check-report.html
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # iOS JOBS
  # ============================================
  ios-lint:
    name: iOS - Lint (SwiftLint)
    needs: detect-changes
    if: needs.detect-changes.outputs.ios == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: ./ios
        run: swiftlint lint --reporter github-actions-logging || echo "SwiftLint completed with warnings"

  ios-build:
    name: iOS - Build
    needs: detect-changes
    if: needs.detect-changes.outputs.ios == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app || sudo xcode-select -s /Applications/Xcode.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Cache Swift Package Manager dependencies
        uses: actions/cache@v3
        with:
          path: ios/.build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install CocoaPods (if Podfile exists)
        working-directory: ./ios
        run: |
          if [ -f "Podfile" ]; then
            echo "Installing CocoaPods dependencies..."
            pod install
          else
            echo "No Podfile found, skipping CocoaPods installation"
          fi

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build iOS app (Debug)
        working-directory: ./ios
        run: |
          set -o pipefail
          xcodebuild clean build \
            -project MenuMaker.xcodeproj \
            -scheme MenuMaker \
            -sdk iphoneos \
            -configuration Debug \
            -destination 'generic/platform=iOS' \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty

      - name: Build summary
        run: |
          echo "âœ… iOS app built successfully"
          echo "Project: MenuMaker.xcodeproj"
          echo "Scheme: MenuMaker"
          echo "Swift files: $(find ios/MenuMaker -name '*.swift' | wc -l)"

  ios-test:
    name: iOS - Unit Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.ios == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app || sudo xcode-select -s /Applications/Xcode.app

      - name: Install CocoaPods (if Podfile exists)
        working-directory: ./ios
        run: |
          if [ -f "Podfile" ]; then
            echo "Installing CocoaPods dependencies..."
            pod install
          else
            echo "No Podfile found, skipping CocoaPods installation"
          fi

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Run unit tests
        working-directory: ./ios
        run: |
          set -o pipefail
          xcodebuild test \
            -project MenuMaker.xcodeproj \
            -scheme MenuMaker \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16' \
            -enableCodeCoverage YES \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-test-results
          path: |
            ios/build/Logs/Test/*.xcresult
          retention-days: 7
          if-no-files-found: ignore

      - name: Test summary
        run: |
          echo "âœ… iOS tests completed"
          echo "Test target: MenuMakerTests"
          echo "Simulator: iPhone 16"

  ios-security:
    name: iOS - Security Analysis
    needs: detect-changes
    if: needs.detect-changes.outputs.ios == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint with security rules
        working-directory: ./ios
        run: |
          echo "ğŸ”’ Running SwiftLint with security focus..."
          swiftlint lint --strict --reporter json > swiftlint-results.json || echo "âš ï¸  SwiftLint found issues"
          swiftlint lint --reporter github-actions-logging

      - name: Check for hardcoded secrets in Swift files
        working-directory: ./ios
        run: |
          echo "ğŸ”‘ Scanning for hardcoded secrets..."
          grep -r "password\|secret\|apiKey\|token" MenuMaker --include="*.swift" || echo "âœ… No obvious secrets found"
          grep -r "http://" MenuMaker --include="*.swift" && echo "âš ï¸  Found non-HTTPS URLs" || echo "âœ… All URLs use HTTPS"

      - name: Check for insecure API usage
        working-directory: ./ios
        run: |
          echo "ğŸ”’ Checking for security-sensitive API usage..."
          grep -r "NSAllowsArbitraryLoads" MenuMaker --include="*.plist" && echo "âŒ App Transport Security disabled" || echo "âœ… ATS enabled"
          grep -r "UIWebView" MenuMaker --include="*.swift" && echo "âš ï¸  Deprecated UIWebView usage" || echo "âœ… No UIWebView usage"
          grep -r "NSTemporaryDirectory()" MenuMaker --include="*.swift" && echo "âš ï¸  Using temp directory" || echo "âœ… No temp directory usage"

      - name: Check for insecure data storage
        working-directory: ./ios
        run: |
          echo "ğŸ—„ï¸  Checking data storage security..."
          grep -r "UserDefaults" MenuMaker --include="*.swift" && echo "âš ï¸  UserDefaults usage detected - ensure no sensitive data" || echo "âœ… No UserDefaults usage"
          grep -r "kSecAttrAccessible" MenuMaker --include="*.swift" || echo "ğŸ’¡ Consider using Keychain for sensitive data"

      - name: Check CocoaPods for vulnerabilities (if Podfile exists)
        working-directory: ./ios
        run: |
          if [ -f "Podfile.lock" ]; then
            echo "ğŸ“¦ Checking CocoaPods dependencies..."
            grep -A 3 "PODS:" Podfile.lock | head -20
            echo "âš ï¸  Manual review recommended for CocoaPods vulnerabilities"
          else
            echo "âœ… No CocoaPods dependencies"
          fi

      - name: Check for debug/logging in release builds
        working-directory: ./ios
        run: |
          echo "ğŸª² Checking for debug code..."
          grep -r "print(" MenuMaker --include="*.swift" && echo "ğŸ’¡ Consider removing debug print statements" || echo "âœ… No print statements"
          grep -r "#if DEBUG" MenuMaker --include="*.swift" && echo "âœ… Debug flags used properly" || echo "ğŸ’¡ No debug flags found"

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-security-reports
          path: |
            ios/swiftlint-results.json
          retention-days: 30
          if-no-files-found: ignore

  # ============================================
  # SUMMARY JOB
  # ============================================
  ci-success:
    name: CI Pipeline Success
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - backend-lint
      - backend-test
      - backend-build
      - backend-typecheck
      - backend-security
      - frontend-lint
      - frontend-test
      - frontend-build
      - frontend-typecheck
      - frontend-security
      - android-lint
      - android-test
      - android-build
      - android-security
      - ios-lint
      - ios-build
      - ios-test
      - ios-security
    if: always()

    steps:
      - name: Check required jobs
        run: |
          echo "Checking CI pipeline status..."

          # Backend checks (if backend changed)
          if [ "${{ needs.detect-changes.outputs.backend }}" == "true" ]; then
            if [ "${{ needs.backend-test.result }}" != "success" ] || \
               [ "${{ needs.backend-build.result }}" != "success" ]; then
              echo "âŒ Backend checks failed"
              exit 1
            fi
            echo "âœ… Backend checks passed"
          fi

          # Frontend checks (if frontend changed)
          if [ "${{ needs.detect-changes.outputs.frontend }}" == "true" ]; then
            if [ "${{ needs.frontend-build.result }}" != "success" ]; then
              echo "âŒ Frontend checks failed"
              exit 1
            fi
            echo "âœ… Frontend checks passed"
          fi

          # Android checks (if android changed)
          if [ "${{ needs.detect-changes.outputs.android }}" == "true" ]; then
            if [ "${{ needs.android-test.result }}" != "success" ] || \
               [ "${{ needs.android-build.result }}" != "success" ]; then
              echo "âŒ Android checks failed"
              exit 1
            fi
            echo "âœ… Android checks passed"
          fi

          # iOS checks (if iOS changed)
          if [ "${{ needs.detect-changes.outputs.ios }}" == "true" ]; then
            if [ "${{ needs.ios-test.result }}" != "success" ] || \
               [ "${{ needs.ios-build.result }}" != "success" ]; then
              echo "âŒ iOS checks failed"
              exit 1
            fi
            echo "âœ… iOS checks passed"
          fi

          echo ""
          echo "ğŸ‰ All CI checks passed successfully!"

      - name: Post summary comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const backendChanged = '${{ needs.detect-changes.outputs.backend }}' === 'true';
            const frontendChanged = '${{ needs.detect-changes.outputs.frontend }}' === 'true';
            const androidChanged = '${{ needs.detect-changes.outputs.android }}' === 'true';
            const iosChanged = '${{ needs.detect-changes.outputs.ios }}' === 'true';

            let summary = '## ğŸ“Š CI/CD Pipeline Summary\n\n';
            summary += '### Changed Components\n\n';

            if (backendChanged) summary += '- âœ… Backend\n';
            if (frontendChanged) summary += '- âœ… Frontend\n';
            if (androidChanged) summary += '- âœ… Android\n';
            if (iosChanged) summary += '- âœ… iOS\n';

            if (!backendChanged && !frontendChanged && !androidChanged && !iosChanged) {
              summary += '- â„¹ï¸ No platform code changes detected\n';
            }

            summary += '\n### Pipeline Results\n\n';
            summary += '| Component | Lint | Test | Build | Status |\n';
            summary += '|-----------|------|------|-------|--------|\n';

            if (backendChanged) {
              const status = '${{ needs.backend-build.result }}' === 'success' ? 'âœ…' : 'âŒ';
              summary += `| Backend | ${'${{ needs.backend-lint.result }}'} | ${'${{ needs.backend-test.result }}'} | ${'${{ needs.backend-build.result }}'} | ${status} |\n`;
            }

            if (frontendChanged) {
              const status = '${{ needs.frontend-build.result }}' === 'success' ? 'âœ…' : 'âŒ';
              summary += `| Frontend | ${'${{ needs.frontend-lint.result }}'} | ${'${{ needs.frontend-test.result }}'} | ${'${{ needs.frontend-build.result }}'} | ${status} |\n`;
            }

            if (androidChanged) {
              const status = '${{ needs.android-build.result }}' === 'success' ? 'âœ…' : 'âŒ';
              summary += `| Android | ${'${{ needs.android-lint.result }}'} | ${'${{ needs.android-test.result }}'} | ${'${{ needs.android-build.result }}'} | ${status} |\n`;
            }

            if (iosChanged) {
              const status = '${{ needs.ios-build.result }}' === 'success' ? 'âœ…' : 'âŒ';
              summary += `| iOS | ${'${{ needs.ios-lint.result }}'} | ${'${{ needs.ios-test.result }}'} | ${'${{ needs.ios-build.result }}'} | ${status} |\n`;
            }

            summary += '\n---\n';
            summary += '_Smart CI/CD: Only affected components were tested_\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
